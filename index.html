<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FlowerFit: Flowers for Your Climate & Colors</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script> <!-- using tailwind for quick changes in index.html file -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background-image: url('flower-background.jpg'); /* image from google, creative commons license free to use */
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #4b5563; 
      position: relative; /* overlay */
      z-index: 0;
    }
    /* opaque overlay */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.35);
      z-index: -1;
    }
    /*
      BUTTON STYLING
    */
    button:not(.close-btn) {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.2s;
    }
    button:not(.close-btn):hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .tag {
        font-weight: bold;
    }
  </style>
</head>
<body class="bg-emerald-150 flex items-center justify-center min-h-screen p-4">
  <div class="max-w-4xl w-full mx-auto p-8 bg-emerald-100 rounded-xl shadow-2xl space-y-8">

    <!-- TITLE + large text background (in front of image) -->
    <header class="text-center">
      <h1 class="text-5xl font-extrabold text-gray-800">FlowerFit 🌸</h1>
      <p class="mt-2 text-xl text-gray-600">Flowers That Thrive, Communities That Flourish</p>
    </header>

    <!-- MISSION STATEMENT SECTION -->
    <section class="bg-emerald-170 p-6 rounded-lg border-l-4 border-gray-600">
      <h2 class="text-2xl font-bold text-gray-700">Mission</h2>
      <p class="mt-2 text-gray-700">
        In addition to enhancing aesthetics, this project aims to address critical environmental issues while also helping new gardeners make informed, sustainable choices. By suggesting plants suited to your local climate, we contribute to:
      </p>
      <ul class="list-disc list-inside mt-4 text-gray-700 space-y-2">
        <li>
          <span class="font-semibold text-black">Protecting Pollinators:</span> We recommend pollinator-friendly flowers, helping to restore habitats for bees and butterflies.
        </li>
        <li>
          <span class="font-semibold text-black">Reducing Garden Waste:</span> We increase planting success and reduce waste by guiding you to plants that thrive naturally in your area.
        </li>
        <li>
          <span class="font-semibold text-black">Fostering Biodiversity:</span> We encourage the use of native species to support local ecosystems and biodiversity.
        </li>
      </ul>
    </section>

    <!-- LOCATION SECTION -->
    <div class="card p-6 bg-emerald-170 rounded-lg shadow-md">
      <h2 class="text-2xl font-semibold text-gray-800">1. Your Location / Climate Zone</h2>
      <p class="mt-4 text-gray-600">
        <button id="detect-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">Use My Location</button>
        <span class="text-gray-500 mx-4">or enter ZIP:</span>
        <input id="zip" placeholder="e.g. 90210" class="border border-gray-300 rounded-lg p-2 w-32 focus:border-gray-500 focus:ring-gray-500" />
        <button id="lookup-zip" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">Lookup</button>
      </p>
      <p id="zone-info" class="mt-4 text-xl font-medium">Zone: <em class="text-red-500 font-bold">unknown</em></p>
      <div id="error-message" class="text-red-500 mt-2 hidden"></div>
      <p class="text-sm text-gray-500 mt-2">Hardiness zones help determine plants that survive winter lows. <a href="https://planthardiness.ars.usda.gov/" target="_blank" class="text-gray-500 hover:underline">See USDA map</a>.</p>
    </div>

    <!-- FLOWERS SECTION -->
    <div class="card p-6 bg-emerald-170 rounded-lg shadow-md hidden" id="flowers-block">
      <h2 class="text-2xl font-semibold text-gray-800">2. Recommended Flowers</h2>
      <p class="mt-4 text-gray-600">Based on your zone, these are great sustainable picks:</p>
      <ul class="flower-list list-none p-0 mt-4 space-y-4" id="flower-list"></ul>
      <div class="flex items-center space-x-2 mt-6">
        <span class="text-sm font-semibold text-gray-700">Can't find what you're looking for?</span>
        <button id="generate-new-flower" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">Suggest a New Flower</button>
      </div>
      <div id="new-flower-loader" class="mt-4 flex items-center space-x-2 hidden">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-900"></div>
        <span class="text-gray-500">Generating suggestion...</span>
      </div>
    </div>

    <!-- COLOR SCHEME SECTION (maybe get rid of idk yet) -->
    <div class="card p-6 bg-emerald-170 rounded-lg shadow-md hidden" id="colors-block">
      <h2 class="text-2xl font-semibold text-gray-800">3. Color Scheme Suggestions</h2>
      <p class="mt-4 text-gray-600">Pick a style that fits your aesthetic:</p>
      <div class="grid md:grid-cols-3 gap-6 mt-6">
        <div>
          <strong class="text-gray-700">Complementary</strong>
          <div class="palette flex gap-2 mt-2" id="comp-palette"></div>
        </div>
        <div>
          <strong class="text-gray-700">Analogous</strong>
          <div class="palette flex gap-2 mt-2" id="analog-palette"></div>
        </div>
        <div>
          <strong class="text-gray-700">Dominant / Secondary / Accent</strong>
          <div class="palette flex gap-2 mt-2" id="rule-palette"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL POPUP -->
  <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
        <div class="mt-2 px-7 py-3">
          <p class="text-sm text-gray-500" id="modal-content"></p>
        </div>
        <div class="items-center px-4 py-3">
          <button id="close-modal" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 close-btn">
            OK
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // modal popup function
    function showModal(title, message) {
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-content').innerText = message;
      document.getElementById('message-modal').style.display = 'block';
    }

    // ev listener
    document.getElementById('close-modal').addEventListener('click', () => {
      document.getElementById('message-modal').style.display = 'none';
    });

    // core logic
    document.addEventListener('DOMContentLoaded', () => {
      const zipToZone = {
        '902': '10b', // socal
        '100': '7b', // nyc
        '606': '6a', // chicago
        '733': '8b', // texas
      };

      const zoneFlowers = {
        '10b': [
          { name: 'Sunflower', color: 'yellow', notes: 'Grows well in heat and full sun.', pollinator: true, native: false },
          { name: 'Marigold', color: 'orange', notes: 'Deters pests and is very easy to grow.', pollinator: false, native: false },
          { name: 'Geranium', color: 'red', notes: 'Popular for containers and flower beds.', pollinator: true, native: false },
          { name: 'Hibiscus', color: 'pink/red', notes: 'Tropical flowers that thrive in full sun.', pollinator: true, native: false },
          { name: 'Bougainvillea', color: 'magenta', notes: 'Vibrant vine that is drought and heat tolerant.', pollinator: true, native: false }
        ],
        '7b': [
          { name: 'Tulip', color: 'mixed', notes: 'Classic spring flower, thrives in cooler climates.', pollinator: false, native: false },
          { name: 'Lavender', color: 'purple', notes: 'Fragrant and attracts beneficial insects.', pollinator: true, native: false },
          { name: 'Hostas', color: 'green', notes: 'Prefers shade and is easy to maintain.', pollinator: false, native: false },
          { name: 'Dahlia', color: 'mixed', notes: 'Come in many shapes and colors. A late summer favorite.', pollinator: true, native: false },
          { name: 'Petunia', color: 'mixed', notes: 'Common and vibrant bedding plant.', pollinator: true, native: false }
        ],
        '6a': [
          { name: 'Roses', color: 'mixed', notes: 'Classic flower that needs a bit of care.', pollinator: true, native: false },
          { name: 'Hydrangea', color: 'blue/pink', notes: 'Large, showy blooms for cold climates.', pollinator: false, native: false },
          { name: 'Lilac', color: 'purple', notes: 'Fragrant and low-maintenance shrub.', pollinator: true, native: false },
          { name: 'Iris', color: 'mixed', notes: 'Elegant perennial with unique flower shapes.', pollinator: true, native: false },
          { name: 'Daylily', color: 'yellow/orange', notes: 'Hardy and low-maintenance. Returns every year.', pollinator: false, native: false }
        ],
        '8b': [
          { name: 'Zinnia', color: 'mixed', notes: 'Attracts butterflies and blooms all summer.', pollinator: true, native: false },
          { name: 'Daffodil', color: 'yellow/white', notes: 'Reliable spring flower that returns every year.', pollinator: false, native: false },
          { name: 'Texas Bluebonnet', color: 'blue', notes: 'The state flower of Texas, a beautiful native annual.', pollinator: true, native: true },
          { name: 'Crape Myrtle', color: 'pink/white/red', notes: 'A beautiful small tree or shrub with long-lasting blooms.', pollinator: true, native: false },
          { name: 'Petunia', color: 'mixed', notes: 'Common and vibrant bedding plant.', pollinator: true, native: false }
        ]
      };

      let currentZone = null;

      function showFlowers(zone) {
        const list = document.getElementById('flower-list');
        list.innerHTML = '';
        const flowers = zoneFlowers[zone] || [];
        if (!flowers.length) {
          list.innerHTML = '<li class="text-gray-500">No sample data for this zone yet.</li>';
        } else {
          flowers.forEach(f => {
            const li = document.createElement('li');
            li.className = 'border-b pb-4';
            let tags = [];
            if (f.pollinator) tags.push('<span class="tag bg-green-200 text-green-800">🐝 Pollinator-Friendly</span>');
            if (f.native) tags.push('<span class="tag bg-gray-200 text-gray-800">🌎 Native Plant</span>');
            
            li.innerHTML = `
              <div class="flex items-center space-x-2">
                <strong class="text-xl text-gray-800">${f.name}</strong>
                <span class="text-gray-600">(${f.color})</span>
              </div>
              <p class="mt-1 text-gray-500">${f.notes}</p>
              <div class="mt-2 flex flex-wrap gap-2">
                ${tags.join('')}
              </div>
            `;
            list.appendChild(li);
          });
        }
        document.getElementById('flowers-block').classList.remove('hidden');
      }

      function setZone(zone) {
        currentZone = zone;
        document.getElementById('zone-info').innerHTML = `Zone: <em class="text-gray-600 font-bold">${zone}</em>`;
        showFlowers(zone);
        generatePalettes();
        document.getElementById('colors-block').classList.remove('hidden');
      }

      document.getElementById('lookup-zip').onclick = () => {
        const raw = document.getElementById('zip').value.trim();
        const prefix = raw.slice(0, 3);
        const zone = zipToZone[prefix];
        if (zone) {
          setZone(zone);
          document.getElementById('error-message').classList.add('hidden');
        } else {
          document.getElementById('error-message').classList.remove('hidden');
          document.getElementById('error-message').innerText = 'Please enter a valid sample ZIP code prefix (e.g., 902, 100, 606, 733).';
        }
      };

      document.getElementById('detect-btn').onclick = () => {
        if (!navigator.geolocation) {
          showModal('Geolocation Error', 'Geolocation is not supported by your browser.');
          return;
        }
        navigator.geolocation.getCurrentPosition(p => {
          // In a real app, this would call a geocoding API.
          // For this demo, we'll assume a hardcoded zone.
          const demoZone = '7b';
          setZone(demoZone);
          document.getElementById('error-message').classList.add('hidden');
        }, () => {
          showModal('Geolocation Error', 'Permission to access location was denied.');
        });
      };

      // Generates palettes based on a hardcoded base color
      function generatePalettes() {
        const comp = ['#4b5563', '#a3b18a']; // gray/green
        const analog = ['#4b5563', '#6b7280', '#374151']; // gray analogous
        const rule = ['#4b5563', '#9ca3af', '#6b7280']; // dominant, secondary, accent

        const setSwatches = (id, arr) => {
          const container = document.getElementById(id);
          container.innerHTML = '';
          arr.forEach(c => {
            const d = document.createElement('div');
            d.className = 'swatch flex-1 h-12 rounded-lg';
            d.style.background = c;
            container.appendChild(d);
          });
        };
        setSwatches('comp-palette', comp);
        setSwatches('analog-palette', analog);
        setSwatches('rule-palette', rule);
      }

      // TODO: fix api calling
      document.getElementById('generate-new-flower').onclick = async () => {
        if (!currentZone) {
          showModal('Error', 'Please enter your climate zone first.');
          return;
        }
        
        const loader = document.getElementById('new-flower-loader');
        loader.classList.remove('hidden');
        
        const prompt = `Suggest one new flower for USDA hardiness zone ${currentZone}. Focus on a plant that is either native, pollinator-friendly, or drought-tolerant. Provide the flower name, a short note, and a color. Format the response as a JSON object with keys: "name", "color", "notes". Do not include any text other than the JSON object.`;
        
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "name": { "type": "STRING" },
                        "color": { "type": "STRING" },
                        "notes": { "type": "STRING" }
                    },
                    "propertyOrdering": ["name", "color", "notes"]
                }
            }
        };

        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // api call backoff
        let response;
        let delay = 1000;
        let success = false;
        const maxRetries = 5;
        let retries = 0;

        while (!success && retries < maxRetries) {
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 429) {
                    retries++;
                    console.log(`Rate limit exceeded. Retrying in ${delay}ms...`);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                } else if (!response.ok) {
                    throw new Error(`API response was not ok: ${response.status}`);
                } else {
                    success = true;
                }
            } catch (error) {
                console.error("Fetch failed:", error);
                retries++;
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
        }

        loader.classList.add('hidden');

        if (success && response) {
            try {
                const result = await response.json();
                const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (jsonString) {
                  const newFlower = JSON.parse(jsonString);
                  // Add to the demo data and display
                  const newEntry = {
                    name: newFlower.name,
                    color: newFlower.color,
                    notes: newFlower.notes,
                    // water: 'low', // Assuming low water for demo
                    pollinator: true, // Assuming pollinator for demo
                    native: true // Assuming native for demo
                  };

                  if (zoneFlowers[currentZone]) {
                    zoneFlowers[currentZone].push(newEntry);
                  } else {
                    zoneFlowers[currentZone] = [newEntry];
                  }
                  
                  showFlowers(currentZone);
                } else {
                  throw new Error("Invalid JSON response from API.");
                }
            } catch (error) {
                console.error("Failed to parse JSON or process data:", error);
                showModal('Error', 'Failed to generate a new flower. Please try again.');
            }
        } else {
            showModal('Error', 'Failed to reach the API after several retries. Please check your network and try again.');
        }
      };
    });
  </script>
</body>
</html>
